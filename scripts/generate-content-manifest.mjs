
import fs from 'fs';
import path from 'path';
import matter from 'gray-matter';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.resolve(__dirname, '..');

const CONTENT_DIR = path.join(projectRoot, 'src', 'content');
const OUTPUT_FILE = path.join(projectRoot, 'src', 'lib', 'content', 'content-manifest.generated.ts');

const CATEGORIES = [
    'basics',
    'sizing',
    'cost',
    'comparisons',
    'how-to',
    'incentives',
    'future',
    'markets',
];

console.log('üîÑ Generating content manifest...');

const manifest = [];

CATEGORIES.forEach(category => {
    const categoryPath = path.join(CONTENT_DIR, category);

    if (fs.existsSync(categoryPath)) {
        const files = fs.readdirSync(categoryPath).filter(file => file.endsWith('.mdx'));

        files.forEach(file => {
            const filePath = path.join(categoryPath, file);
            const fileContent = fs.readFileSync(filePath, 'utf-8');
            const { data, content } = matter(fileContent);

            // Reconstruct the full source with frontmatter for compileMDX
            // distinct from just 'content' which strips it
            const rawSource = fileContent;

            manifest.push({
                title: data.title || '',
                description: data.description || '',
                updated: data.updated || '',
                category: data.category || category,
                slug: data.slug || file.replace('.mdx', ''),
                readingMinutes: data.readingMinutes || 0,
                source: rawSource
            });
        });
        console.log(`   ‚úÖ Processed ${category}: ${files.length} articles`);
    } else {
        console.log(`   ‚ö†Ô∏è Category not found: ${category}`);
    }
});

const fileContent = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
 * Generated by scripts/generate-content-manifest.mjs
 */

export interface ManifestRecord {
    title: string;
    description: string;
    updated: string;
    category: string;
    slug: string;
    readingMinutes: number;
    source: string;
}

export const CONTENT_MANIFEST: ManifestRecord[] = ${JSON.stringify(manifest, null, 4)};
`;

try {
    fs.writeFileSync(OUTPUT_FILE, fileContent);
    console.log(`üöÄ Manifest generated at ${OUTPUT_FILE} (${manifest.length} total articles)`);
} catch (error) {
    console.error(`‚ùå Error writing manifest: ${error.message}`);
    process.exit(1);
}
